{"version":3,"file":"layersLoader-4ac2cff9.js","sources":["../../node_modules/@arcgis/core/portal/support/layersLoader.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.26/esri/copyright.txt for details.\n*/\nimport e from\"../../core/Error.js\";import t from\"../../layers/Layer.js\";import{isArcGISUrl as r}from\"../../layers/support/arcgisLayerUrl.js\";import{fetchFeatureService as a}from\"../../layers/support/fetchService.js\";import n from\"../Portal.js\";import o from\"../PortalItem.js\";import{createForItemRead as l}from\"./jsonContext.js\";import{hasTypeKeyword as s}from\"./portalItemUtils.js\";import{loadStyleRenderer as i}from\"../../renderers/support/styleUtils.js\";import{fetchArcGISServiceJSON as u}from\"../../support/requestPresets.js\";async function p(e,t){const r=e.instance.portalItem;if(r&&r.id)return await r.load(t),c(e),y(e,t)}function c(t){const r=t.instance.portalItem;if(!r?.type||!t.supportedTypes.includes(r.type))throw new e(\"portal:invalid-layer-item-type\",\"Invalid layer item type '${type}', expected '${expectedType}'\",{type:r?.type,expectedType:t.supportedTypes.join(\", \")})}async function y(e,t){const r=e.instance,a=r.portalItem;if(!a)return;const{url:n,title:o}=a,s=l(a);if(\"group\"===r.type)return r.read({title:o},s),d(r,e);n&&r.read({url:n},s);const u=await h(e,t);return u&&r.read(u,s),r.resourceReferences={portalItem:a,paths:s.readResourcePaths??[]},\"subtype-group\"!==r.type&&r.read({title:o},s),i(r,s)}async function d(t,r){let a;const{portalItem:n}=t;if(!n)return;const o=n.type,l=r.layerModuleTypeMap,i=s(n,\"Oriented Imagery Layer\")??!1;switch(o){case\"Feature Service\":a=i?l.OrientedImageryLayer:l.FeatureLayer;break;case\"Stream Service\":a=l.StreamLayer;break;case\"Scene Service\":a=l.SceneLayer;break;case\"Feature Collection\":a=l.FeatureLayer;break;default:throw new e(\"portal:unsupported-item-type-as-group\",`The item type '${o}' is not supported as a 'IGroupLayer'`)}let[u,p]=await Promise.all([a(),h(r)]),c=()=>u;if(\"Feature Service\"===o){p=n.url?await w(p,n.url):{};if(j(p).length){const e=l.SubtypeGroupLayer,t=await e();c=e=>\"SubtypeGroupLayer\"===e.layerType?t:u}return b(t,c,p,await P(n.url))}return v(p)>0?b(t,c,p):f(t,c)}async function f(e,t){const{portalItem:r}=e;if(!r?.url)return;const a=await u(r.url);a&&b(e,t,{layers:a.layers?.map(m),tables:a.tables?.map(m)})}function m(e){return{id:e.id,name:e.name}}function b(e,t,r,a){let n=r.layers||[];const o=r.tables||[];if(\"Feature Collection\"===e.portalItem?.type&&(n.forEach((e=>{\"Table\"===e?.layerDefinition?.type&&o.push(e)})),n=n.filter((e=>\"Table\"!==e?.layerDefinition?.type))),\"coverage\"in r){const t=T(r);t&&e.add(t)}n.reverse().forEach((n=>{const o=g(e,t(n),r,n,a?.(n));e.add(o)})),o.reverse().forEach((n=>{const o=g(e,t(n),r,n,a?.(n));e.tables.add(o)}))}function g(e,t,r,a,o){const l=e.portalItem,s=new t({portalItem:l.clone(),layerId:a.id});if(\"sourceJSON\"in s&&(s.sourceJSON=o),\"subtype-group\"!==s.type&&(s.sublayerTitleMode=\"service-name\"),\"Feature Collection\"===l.type){const e={origin:\"portal-item\",portal:l.portal||n.getDefault()};s.read(a,e);const t=r.showLegend;null!=t&&s.read({showLegend:t},e)}return s}async function h(e,t){if(!1===e.supportsData)return;const r=e.instance,a=r.portalItem;if(!a)return;let n=null;try{n=await a.fetchData(\"json\",t)}catch(o){}if(S(r)){let e=null,t=!0;if(n&&v(n)>0){if(null==r.layerId){const e=j(n);r.layerId=\"subtype-group\"===r.type?e?.[0]:I(n)}e=L(n,r),e&&(1===v(n)&&(t=!1),null!=n.showLegend&&(e.showLegend=n.showLegend))}return t&&\"service-name\"!==r.sublayerTitleMode&&(r.sublayerTitleMode=\"item-title-and-service-name\"),e}return n}async function w(e,t){if(null==e?.layers||null==e?.tables){const r=await u(t);(e=e||{}).layers=e.layers||r?.layers,e.tables=e.tables||r?.tables}return e}function I(e){const t=e.layers;if(t&&t.length)return t[0].id;const r=e.tables;return r&&r.length?r[0].id:null}function L(e,t){const{layerId:r}=t,a=e.layers?.find((e=>e.id===r))||e.tables?.find((e=>e.id===r));return a&&F(a,t)?a:null}function v(e){return(e?.layers?.length??0)+(e?.tables?.length??0)}function S(e){return\"stream\"!==e.type&&\"oriented-imagery\"!==e.type&&\"layerId\"in e}function T(a){const{coverage:n}=a;if(!n)return null;const l=new URL(n);if(n.toLowerCase().includes(\"item.html\")){const e=l.searchParams.get(\"id\"),r=l.origin;return t.fromPortalItem({portalItem:new o({id:e,url:r})})}if(r(n))return t.fromArcGISServerUrl({url:n});throw new e(\"portal:oriented-imagery-layer-coverage\",\"the provided coverage url couldn't be loaded as a layer\")}function j(e){const t=[];return e?.layers?.forEach((e=>{\"SubtypeGroupLayer\"===e.layerType&&t.push(e.id)})),t}function F(e,t){return!(\"feature\"===t.type&&\"layerType\"in e&&\"SubtypeGroupLayer\"===e.layerType||\"subtype-group\"===t.type&&!(\"layerType\"in e))}async function P(e){const{layersJSON:t}=await a(e);if(!t)return null;const r=[...t.layers,...t.tables];return e=>r.find((t=>t.id===e.id))}export{I as getFirstLayerOrTableId,v as getNumLayersAndTables,j as getSubtypeGroupLayerIds,p as load,w as preprocessFSItemData};\n"],"names":["p","t","r","c","y","e","o","l","d","u","h","i","a","n","s","w","j","b","P","v","f","_a","m","_b","T","g","S","I","L","F"],"mappings":"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"}