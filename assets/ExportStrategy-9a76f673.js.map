{"version":3,"file":"ExportStrategy-9a76f673.js","sources":["../../node_modules/@arcgis/core/views/2d/viewStateUtils.js","../../node_modules/@arcgis/core/views/2d/layers/support/ExportStrategy.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.26/esri/copyright.txt for details.\n*/\nconst t=Math.PI/180;function n(n){return n*t}function o(t,o){const a=n(o.rotation),r=Math.abs(Math.cos(a)),s=Math.abs(Math.sin(a)),[u,c]=o.size;return t[0]=Math.round(c*s+u*r),t[1]=Math.round(c*r+u*s),t}function a(t,n,o,a){const[r,s]=n,[u,c]=a,h=.5*o;return t[0]=r-h*u,t[1]=s-h*c,t[2]=r+h*u,t[3]=s+h*c,t}export{a as getBBox,o as getOuterSize};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.26/esri/copyright.txt for details.\n*/\nimport{_ as t}from\"../../../../chunks/tslib.es6.js\";import e from\"../../../../core/Accessor.js\";import\"../../../../core/has.js\";import{debounce as i,throwIfAborted as o,throwIfAbortError as r,eachAlways as s}from\"../../../../core/promiseUtils.js\";import{property as a}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/accessorSupport/ensureType.js\";import\"../../../../core/arrayUtils.js\";import{subclass as n}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{create as p,toExtent as m}from\"../../../../geometry/support/aaBoundingRect.js\";import{getInfo as l}from\"../../../../geometry/support/spatialReferenceUtils.js\";import d from\"../../../../layers/support/TileInfo.js\";import{getOuterSize as h,getBBox as c}from\"../../viewStateUtils.js\";import{Bitmap as u}from\"../../engine/Bitmap.js\";import g from\"../../tiling/TileInfoView.js\";import f from\"../../tiling/TileKey.js\";const y=p(),x=[0,0],S=new f(0,0,0,0),_={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};let w=class extends e{constructor(t){super(t),this._imagePromise=null,this.bitmaps=[],this.hidpi=_.hidpi,this.imageMaxWidth=_.imageMaxWidth,this.imageMaxHeight=_.imageMaxHeight,this.imageRotationSupported=_.imageRotationSupported,this.imageNormalizationSupported=_.imageNormalizationSupported,this.update=i((async(t,e)=>{if(o(e),!t.stationary||this.destroyed)return;const i=t.state,s=l(i.spatialReference),a=this.hidpi?t.pixelRatio:1,n=this.imageNormalizationSupported&&i.worldScreenWidth&&i.worldScreenWidth<i.size[0],p=this.imageMaxWidth??0,m=this.imageMaxHeight??0;n?(x[0]=i.worldScreenWidth,x[1]=i.size[1]):this.imageRotationSupported?(x[0]=i.size[0],x[1]=i.size[1]):h(x,i);const d=Math.floor(x[0]*a)>p||Math.floor(x[1]*a)>m,c=s&&(i.extent.xmin<s.valid[0]||i.extent.xmax>s.valid[1]),u=!this.imageNormalizationSupported&&c,g=!d&&!u,f=this.imageRotationSupported?i.rotation:0,y=this.container.children.slice();if(g){const t=n?i.paddedViewState.center:i.center;this._imagePromise&&console.error(\"Image promise was not defined!\"),this._imagePromise=this._singleExport(i,x,t,i.resolution,f,a,e)}else{let t=Math.min(p,m);u&&(t=Math.min(i.worldScreenWidth,t)),this._imagePromise=this._tiledExport(i,t,a,e)}try{const t=await this._imagePromise??[];o(e);const i=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=t;for(const e of y)t.includes(e)||i.push(e.fadeOut().then((()=>{e.remove(),e.destroy()})));for(const e of t)i.push(e.fadeIn());await Promise.all(i)}catch(S){this._imagePromise=null,r(S)}}),5e3),this.updateExports=i((async t=>{const e=[];for(const i of this.container.children){if(!i.visible||!i.stage)return;e.push(t(i).then((()=>{i.invalidateTexture(),i.requestRender()})))}this._imagePromise=s(e).then((()=>this._imagePromise=null)),await this._imagePromise}))}destroy(){this.bitmaps.forEach((t=>t.destroy())),this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}async _export(t,e,i,r,s,a){const n=await this.fetchSource(t,Math.floor(e*s),Math.floor(i*s),{rotation:r,pixelRatio:s,signal:a});o(a);const p=new u(null,{immutable:!0,requestRenderOnSourceChangedEnabled:!0});return p.x=t.xmin,p.y=t.ymax,p.resolution=t.width/e,p.rotation=r,p.pixelRatio=s,p.opacity=0,this.container.addChild(p),await p.setSourceAsync(n,a),o(a),p}async _singleExport(t,e,i,o,r,s,a){c(y,i,o,e);const n=m(y,t.spatialReference);return[await this._export(n,e[0],e[1],r,s,a)]}_tiledExport(t,e,i,o){const r=d.create({size:e,spatialReference:t.spatialReference,scales:[t.scale]}),s=new g(r),a=s.getTileCoverage(t);if(!a)return null;const n=[];return a.forEach(((r,a,p,l)=>{S.set(r,a,p,0),s.getTileBounds(y,S);const d=m(y,t.spatialReference);n.push(this._export(d,e,e,0,i,o).then((t=>(0!==l&&(S.set(r,a,p,l),s.getTileBounds(y,S),t.x=y[0],t.y=y[3]),t))))})),Promise.all(n)}};t([a()],w.prototype,\"_imagePromise\",void 0),t([a()],w.prototype,\"bitmaps\",void 0),t([a()],w.prototype,\"container\",void 0),t([a()],w.prototype,\"fetchSource\",void 0),t([a()],w.prototype,\"hidpi\",void 0),t([a()],w.prototype,\"imageMaxWidth\",void 0),t([a()],w.prototype,\"imageMaxHeight\",void 0),t([a()],w.prototype,\"imageRotationSupported\",void 0),t([a()],w.prototype,\"imageNormalizationSupported\",void 0),t([a()],w.prototype,\"requestUpdate\",void 0),t([a()],w.prototype,\"updating\",null),w=t([n(\"esri.views.2d.layers.support.ExportStrategy\")],w);const v=w;export{v as default};\n"],"names":["t","n","o","a","r","s","u","c","h","y","p","x","S","f","_","w","e","i","l","d","g","m","v"],"mappings":"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"}