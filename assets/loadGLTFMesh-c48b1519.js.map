{"version":3,"file":"loadGLTFMesh-c48b1519.js","sources":["../../node_modules/@arcgis/core/geometry/support/meshUtils/loadGLTFMesh.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.26/esri/copyright.txt for details.\n*/\nimport e from\"../../../Color.js\";import t from\"../../../request.js\";import{getOrCreateMapValue as r}from\"../../../core/MapUtils.js\";import{hasScaling as o}from\"../../../core/mathUtils.js\";import{isSome as n,unwrap as s,applySome as i,isNone as a}from\"../../../core/maybe.js\";import{b as c}from\"../../../chunks/mat3.js\";import{c as u}from\"../../../chunks/mat3f64.js\";import{f as l}from\"../../../chunks/vec3f64.js\";import{f}from\"../../../chunks/vec4f64.js\";import m from\"../MeshComponent.js\";import p from\"../MeshMaterialMetallicRoughness.js\";import d from\"../MeshTexture.js\";import{MeshVertexAttributes as g}from\"../MeshVertexAttributes.js\";import{BufferViewVec4f as x,BufferViewVec4u8 as T,BufferViewVec4u16 as h,BufferViewVec3u8 as v,BufferViewVec3f as w,BufferViewVec3u16 as b,BufferViewVec3f64 as j,BufferViewVec2f as y}from\"../buffer/BufferView.js\";import{t as A,a as M,n as C,s as R,b as E}from\"../../../chunks/vec32.js\";import{t as k,n as B,s as F,a as I}from\"../../../chunks/vec42.js\";import{createBuffer as $}from\"../buffer/utils.js\";import{georeferenceByTransform as L}from\"./georeference.js\";import{DefaultLoadingContext as S}from\"../../../views/3d/glTF/DefaultLoadingContext.js\";import{loadGLTF as N}from\"../../../views/3d/glTF/loader.js\";import{triangleFanToTriangles as O,triangleStripToTriangles as _,trianglesToTriangles as D}from\"../../../views/3d/glTF/internal/indexUtils.js\";import{isEncodedMeshTexture as G}from\"../../../views/3d/glTF/internal/resourceUtils.js\";import{generateIndexArray as P}from\"../../../views/3d/webgl-engine/lib/Indices.js\";import{COLOR_GAMMA as U}from\"../../../views/3d/webgl-engine/materials/DefaultMaterial_COLOR_GAMMA.js\";import{PrimitiveType as V,TextureWrapMode as q}from\"../../../views/webgl/enums.js\";import{f as z,c as K}from\"../../../chunks/vec33.js\";import{f as Q,c as H}from\"../../../chunks/vec43.js\";import{n as J,f as W}from\"../../../chunks/vec22.js\";async function X(e,t,r){const o=new S(Y(r)),s=(await N(o,t,r,!0)).model,i=s.lods.shift(),a=new Map,c=new Map;s.textures.forEach(((e,t)=>a.set(t,re(e)))),s.materials.forEach(((e,t)=>c.set(t,oe(e,a))));const u=te(i);for(const n of u.parts)ne(u,n,c);const{position:l,normal:f,tangent:m,color:p,texCoord0:d}=u.vertexAttributes,x={position:l.typedBuffer,normal:n(f)?f.typedBuffer:null,tangent:n(m)?m.typedBuffer:null,uv:n(d)?d.typedBuffer:null,color:n(p)?p.typedBuffer:null},T=L(x,e,r);return{transform:T.transform,components:u.components,spatialReference:e.spatialReference,vertexAttributes:new g({position:T.vertexAttributes.position,normal:T.vertexAttributes.normal,tangent:T.vertexAttributes.tangent,color:x.color,uv:x.uv})}}function Y(e){const r=e?.resolveFile;return r?{busy:!1,request:async(e,o,s)=>{const i=r(e),a=\"image\"===o?\"image\":\"binary\"===o?\"array-buffer\":\"json\";return(await t(i,{responseType:a,signal:n(s)?s.signal:null})).data}}:null}function Z(e,t){if(a(e))return\"-\";const o=e.typedBuffer;return`${r(t,o.buffer,(()=>t.size))}/${o.byteOffset}/${o.byteLength}`}function ee(e){return n(e)?e.toString():\"-\"}function te(e){let t=0;const has={color:!1,tangent:!1,normal:!1,texCoord0:!1},o=new Map,n=new Map,s=[];for(const i of e.parts){const{attributes:{position:e,normal:a,color:c,tangent:u,texCoord0:l}}=i,f=`\\n      ${Z(e,o)}/\\n      ${Z(a,o)}/\\n      ${Z(c,o)}/\\n      ${Z(u,o)}/\\n      ${Z(l,o)}/\\n      ${ee(i.transform)}\\n    `;let m=!1;const p=r(n,f,(()=>(m=!0,{start:t,length:e.count})));m&&(t+=e.count),a&&(has.normal=!0),c&&(has.color=!0),u&&(has.tangent=!0),l&&(has.texCoord0=!0),s.push({gltf:i,writeVertices:m,region:p})}return{vertexAttributes:{position:$(j,t),normal:has.normal?$(w,t):null,tangent:has.tangent?$(x,t):null,color:has.color?$(T,t):null,texCoord0:has.texCoord0?$(y,t):null},parts:s,components:[]}}function re(e){return new d({data:(G(e.data),e.data),wrap:ce(e.parameters.wrap)})}function oe(t,r){const o=new e(fe(t.color,t.opacity)),n=t.emissiveFactor?new e(me(t.emissiveFactor)):null;return new p({color:o,colorTexture:s(i(t.textureColor,(e=>r.get(e)))),normalTexture:s(i(t.textureNormal,(e=>r.get(e)))),emissiveColor:n,emissiveTexture:s(i(t.textureEmissive,(e=>r.get(e)))),occlusionTexture:s(i(t.textureOcclusion,(e=>r.get(e)))),alphaMode:ae(t.alphaMode),alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,metallic:t.metallicFactor,roughness:t.roughnessFactor,metallicRoughnessTexture:s(i(t.textureMetallicRoughness,(e=>r.get(e)))),colorTextureTransform:t.colorTextureTransform,normalTextureTransform:t.normalTextureTransform,occlusionTextureTransform:t.occlusionTextureTransform,emissiveTextureTransform:t.emissiveTextureTransform,metallicRoughnessTextureTransform:t.metallicRoughnessTextureTransform})}function ne(e,t,r){t.writeVertices&&se(e,t);const o=t.gltf,n=ie(o.indices||o.attributes.position.count,o.primitiveType),s=t.region.start;if(s)for(let i=0;i<n.length;i++)n[i]+=s;e.components.push(new m({faces:n,material:r.get(o.material),trustSourceNormals:!0}))}function se(e,t){const{position:r,normal:s,tangent:i,color:a,texCoord0:l}=e.vertexAttributes,f=t.region.start,{attributes:m,transform:p}=t.gltf,d=m.position.count;if(A(r.slice(f,d),m.position,p),n(m.normal)&&n(s)){const e=c(u(),p),t=s.slice(f,d);M(t,m.normal,e),o(e)&&C(t,t)}else n(s)&&z(s,0,0,1,{dstIndex:f,count:d});if(n(m.tangent)&&n(i)){const e=c(u(),p),t=i.slice(f,d);k(t,m.tangent,e),o(e)&&B(t,t)}else n(i)&&Q(i,0,0,1,1,{dstIndex:f,count:d});if(n(m.texCoord0)&&n(l)?J(l.slice(f,d),m.texCoord0):n(l)&&W(l,0,0,{dstIndex:f,count:d}),n(m.color)&&n(a)){const e=m.color,t=a.slice(f,d);if(4===e.elementCount)e instanceof x?F(t,e,255):e instanceof T?H(t,e):e instanceof h&&I(t,e,8);else{Q(t,255,255,255,255);const r=v.fromTypedArray(t.typedBuffer,t.typedBufferStride);e instanceof w?R(r,e,255):e instanceof v?K(r,e):e instanceof b&&E(r,e,8)}}else n(a)&&Q(a.slice(f,d),255,255,255,255)}function ie(e,t){switch(t){case V.TRIANGLES:return D(e,P);case V.TRIANGLE_STRIP:return _(e);case V.TRIANGLE_FAN:return O(e)}}function ae(e){switch(e){case\"OPAQUE\":return\"opaque\";case\"MASK\":return\"mask\";case\"BLEND\":return\"blend\"}}function ce(e){return{horizontal:ue(e.s),vertical:ue(e.t)}}function ue(e){switch(e){case q.CLAMP_TO_EDGE:return\"clamp\";case q.MIRRORED_REPEAT:return\"mirror\";case q.REPEAT:return\"repeat\"}}function le(e){return e**(1/U)*255}function fe(e,t){return f(le(e[0]),le(e[1]),le(e[2]),t)}function me(e){return l(le(e[0]),le(e[1]),le(e[2]))}export{X as loadGLTFMesh};\n"],"names":["X","r","o","S","Y","s","N","i","a","c","e","t","re","oe","u","te","n","ne","l","m","p","d","T","L","g","Z","ee","has","f","$","j","w","x","y","G","ce","fe","me","ae","se","ie","A","M","C","z","k","B","Q","J","W","F","H","h","I","v","R","K","b","E","V","D","P","_","O","ue","q","le","U"],"mappings":"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"}