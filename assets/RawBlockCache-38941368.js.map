{"version":3,"file":"RawBlockCache-38941368.js","sources":["../../node_modules/@arcgis/core/layers/support/rasterDatasets/EphemeralBlockCache.js","../../node_modules/@arcgis/core/layers/support/rasterDatasets/RawBlockCache.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.26/esri/copyright.txt for details.\n*/\nclass t{constructor(t=15e3,e=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,e)}decreaseRefCount(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.refCount--,t.refCount<=0&&(r.delete(s),t.controller&&t.controller.abort()),t.refCount}return 0}getBlock(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.ts=Date.now(),t.refCount++,r.delete(s),r.set(s,t),t.block}return null}putBlock(t,e,s,r){const i=this._cachedBlocks,c=t+\"/\"+e;if(i.has(c)){const t=i.get(c);t.ts=Date.now(),t.refCount++}else i.set(c,{block:s,ts:Date.now(),refCount:1,controller:r});this._trim(),this._updateTimer()}deleteBlock(t,e){const s=this._cachedBlocks,r=t+\"/\"+e;s.has(r)&&s.delete(r)}updateMaxSize(t){this._size=t,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(null!=this._timer)return;const t=this._cachedBlocks;this._timer=setInterval((()=>{const e=Array.from(t),s=Date.now();for(let r=0;r<e.length&&e[r][1].ts<=s-this._duration;r++)t.delete(e[r][0]);0===t.size&&this._clearTimer()}),this._interval)}_trim(){const t=this._cachedBlocks;if(-1===this._size||this._size>=t.size)return;const e=Array.from(t);for(let s=0;s<e.length-this._size;s++)t.delete(e[s][0])}_clearTimer(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}export{t as default};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.26/esri/copyright.txt for details.\n*/\nimport\"../../../geometry.js\";import{isSome as e}from\"../../../core/maybe.js\";import t from\"./EphemeralBlockCache.js\";import{projectExtent as n,projectResolution as o,snapPyramid as l}from\"../rasterFunctions/rasterProjectionHelper.js\";import r from\"../../../geometry/Point.js\";const c=new Map,i=new t;function a(e,t){return null==t?e:`${e}?sliceId=${t}`}function u(e,t){const n={extent:null,rasterInfo:t,cache:new Map},o=c.get(e);return o?(o.push(n),o.length-1):(c.set(e,[n]),0)}function f(e,t){const n=c.get(e);n&&(n[t]=null,n.some((e=>null!=e))||c.delete(e))}function s(e){c.delete(e)}function m(e,t,n){const o=c.get(e);if(!o)return null==t?i.decreaseRefCount(e,n):0;if(null==t||null==o[t])return i.decreaseRefCount(e,n);const l=o[t]?.cache,r=l?.get(n);if(l&&r){if(r.refCount--,0===r.refCount){l.delete(n);for(let e=0;e<o.length;e++)o[e]?.cache.delete(n);r.controller&&r.controller.abort()}return r.refCount}return 0}function x(e,t,n){const o=c.get(e);if(!o)return null==t?i.getBlock(e,n):null;if(null==t||null==o[t]){for(let e=0;e<o.length;e++){const t=o[e]?.cache.get(n);if(t)return t.refCount++,t.block}return i.getBlock(e,n)}const l=o[t]?.cache.get(n);if(l)return l.refCount++,l.block;for(let r=0;r<o.length;r++){if(r===t||!o[r])continue;const e=o[r]?.cache,l=e?.get(n);if(e&&l)return l.refCount++,e.set(n,l),l.block}return null}function h(e,t,n,o,l=null){const r=c.get(e);if(!r)return void(null==t&&i.putBlock(e,n,o,l));if(null==t||null==r[t])return void i.putBlock(e,n,o,l);const a={refCount:1,block:o,isResolved:!1,isRejected:!1,controller:l};o.then((()=>a.isResolved=!0)).catch((()=>a.isRejected=!0)),r[t]?.cache.set(n,a)}function d(e,t,n){const o=c.get(e);o?null!=t&&null!=o[t]?o[t]?.cache.delete(n):i.deleteBlock(e,n):null==t&&i.deleteBlock(e,n)}function y(e,t){const n=c.get(e);return n?n[t]??null:null}function g(t,c,i,a,u,f,s=null){const m=y(t,c);if(!m)return;const x=m.extent,{cache:h,rasterInfo:d}=m;if(x&&x.xmin===i.xmin&&x.xmax===i.xmax&&x.ymin===i.ymin&&x.ymax===i.ymax)return;a=a??0;const g=i.clone().normalize(),{spatialReference:p,transform:k}=d,M=new Set;for(let y=0;y<g.length;y++){const t=g[y];if(t.xmax-t.xmin<=a||t.ymax-t.ymin<=a)continue;let c=n(t,p,s);e(k)&&(c=k.inverseTransform(c));const i=new r({x:a,y:a,spatialReference:t.spatialReference});if(null==u&&!(u=o(i,p,t,s)))return;const{pyramidLevel:m,pyramidResolution:x,excessiveReading:h}=l(u,d,f||\"closest\");if(h)return;const{storageInfo:R}=d,{origin:C}=R,j={x:Math.max(0,Math.floor((c.xmin-C.x)/x.x)),y:Math.max(0,Math.floor((C.y-c.ymax)/x.y))},B=Math.ceil((c.xmax-c.xmin)/x.x-.1),b=Math.ceil((c.ymax-c.ymin)/x.y-.1),v=m>0?R.pyramidBlockWidth:R.blockWidth,w=m>0?R.pyramidBlockHeight:R.blockHeight,$=1,I=Math.max(0,Math.floor(j.x/v)-$),H=Math.max(0,Math.floor(j.y/w)-$),E=Math.floor((j.x+B-1)/v)+$,P=Math.floor((j.y+b-1)/w)+$;for(let e=H;e<=P;e++)for(let t=I;t<=E;t++)M.add(`${m}/${e}/${t}`)}h.forEach(((e,t)=>{if(!M.has(t)){const e=h.get(t);(null==e||e.isResolved||e.isRejected)&&h.delete(t)}})),m.extent={xmin:i.xmin,ymin:i.ymin,xmax:i.xmax,ymax:i.ymax}}export{m as decreaseRefCount,d as deleteBlock,s as deleteRaster,x as getBlock,a as getRasterId,h as putBlock,u as register,f as unregister,g as update};\n"],"names":["t","s","i","c","a","e","u","n","o","f","m","l","_a","r","_b","x","_c","h","d","y","g","p","k","M","R","C","j","B","b","v","w","$","I","E","P"],"mappings":"uHAIA,MAAMA,CAAC,CAAC,YAAYA,EAAE,KAAK,EAAE,IAAI,CAAC,KAAK,OAAO,KAAK,KAAK,cAAc,IAAI,IAAI,KAAK,MAAM,GAAG,KAAK,UAAUA,EAAE,KAAK,UAAU,KAAK,IAAIA,EAAE,CAAC,CAAC,CAAC,iBAAiBA,EAAE,EAAE,CAAC,MAAMC,EAAED,EAAE,IAAI,EAAE,EAAE,KAAK,cAAc,GAAG,EAAE,IAAIC,CAAC,EAAE,CAAC,MAAMD,EAAE,EAAE,IAAIC,CAAC,EAAE,OAAOD,EAAE,WAAWA,EAAE,UAAU,IAAI,EAAE,OAAOC,CAAC,EAAED,EAAE,YAAYA,EAAE,WAAW,MAAK,GAAIA,EAAE,QAAQ,CAAC,MAAO,EAAC,CAAC,SAASA,EAAE,EAAE,CAAC,MAAMC,EAAED,EAAE,IAAI,EAAE,EAAE,KAAK,cAAc,GAAG,EAAE,IAAIC,CAAC,EAAE,CAAC,MAAMD,EAAE,EAAE,IAAIC,CAAC,EAAE,OAAOD,EAAE,GAAG,KAAK,IAAK,EAACA,EAAE,WAAW,EAAE,OAAOC,CAAC,EAAE,EAAE,IAAIA,EAAED,CAAC,EAAEA,EAAE,KAAK,CAAC,OAAO,IAAI,CAAC,SAASA,EAAE,EAAEC,EAAE,EAAE,CAAC,MAAMC,EAAE,KAAK,cAAcC,EAAEH,EAAE,IAAI,EAAE,GAAGE,EAAE,IAAIC,CAAC,EAAE,CAAC,MAAMH,EAAEE,EAAE,IAAIC,CAAC,EAAEH,EAAE,GAAG,KAAK,IAAK,EAACA,EAAE,UAAU,MAAME,EAAE,IAAIC,EAAE,CAAC,MAAMF,EAAE,GAAG,KAAK,IAAG,EAAG,SAAS,EAAE,WAAW,CAAC,CAAC,EAAE,KAAK,MAAO,EAAC,KAAK,aAAc,CAAA,CAAC,YAAYD,EAAE,EAAE,CAAC,MAAMC,EAAE,KAAK,cAAc,EAAED,EAAE,IAAI,EAAEC,EAAE,IAAI,CAAC,GAAGA,EAAE,OAAO,CAAC,CAAC,CAAC,cAAcD,EAAE,CAAC,KAAK,MAAMA,EAAE,KAAK,MAAO,CAAA,CAAC,OAAO,CAAC,KAAK,cAAc,MAAK,EAAG,KAAK,YAAW,CAAE,CAAC,gBAAgB,CAAC,OAAO,KAAK,cAAc,IAAI,CAAC,cAAc,CAAC,GAAS,KAAK,QAAX,KAAkB,OAAO,MAAMA,EAAE,KAAK,cAAc,KAAK,OAAO,YAAa,IAAI,CAAC,MAAM,EAAE,MAAM,KAAKA,CAAC,EAAEC,EAAE,KAAK,IAAK,EAAC,QAAQ,EAAE,EAAE,EAAE,EAAE,QAAQ,EAAE,CAAC,EAAE,CAAC,EAAE,IAAIA,EAAE,KAAK,UAAU,IAAID,EAAE,OAAO,EAAE,CAAC,EAAE,CAAC,CAAC,EAAMA,EAAE,OAAN,GAAY,KAAK,YAAa,CAAA,EAAG,KAAK,SAAS,CAAC,CAAC,OAAO,CAAC,MAAMA,EAAE,KAAK,cAAc,GAAQ,KAAK,QAAV,IAAiB,KAAK,OAAOA,EAAE,KAAK,OAAO,MAAM,EAAE,MAAM,KAAKA,CAAC,EAAE,QAAQC,EAAE,EAAEA,EAAE,EAAE,OAAO,KAAK,MAAMA,IAAID,EAAE,OAAO,EAAEC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,aAAa,CAAO,KAAK,QAAX,OAAoB,cAAc,KAAK,MAAM,EAAE,KAAK,OAAO,KAAK,CAAC,CCAtnC,MAAME,EAAE,IAAI,IAAID,EAAE,IAAIF,EAAE,SAASI,EAAEC,EAAEL,EAAE,CAAC,OAAaA,GAAN,KAAQK,EAAE,GAAGA,aAAaL,GAAG,CAAC,SAASM,EAAED,EAAEL,EAAE,CAAC,MAAMO,EAAE,CAAC,OAAO,KAAK,WAAWP,EAAE,MAAM,IAAI,GAAG,EAAEQ,EAAEL,EAAE,IAAIE,CAAC,EAAE,OAAOG,GAAGA,EAAE,KAAKD,CAAC,EAAEC,EAAE,OAAO,IAAIL,EAAE,IAAIE,EAAE,CAACE,CAAC,CAAC,EAAE,EAAE,CAAC,SAASE,EAAEJ,EAAEL,EAAE,CAAC,MAAMO,EAAEJ,EAAE,IAAIE,CAAC,EAAEE,IAAIA,EAAEP,CAAC,EAAE,KAAKO,EAAE,KAAMF,GAASA,GAAN,IAAO,GAAIF,EAAE,OAAOE,CAAC,EAAE,CAA2B,SAASK,EAAEL,EAAEL,EAAEO,EAAE,SAAC,MAAMC,EAAEL,EAAE,IAAIE,CAAC,EAAE,GAAG,CAACG,EAAE,OAAaR,GAAN,KAAQE,EAAE,iBAAiBG,EAAEE,CAAC,EAAE,EAAE,GAASP,GAAN,MAAeQ,EAAER,CAAC,GAAT,KAAW,OAAOE,EAAE,iBAAiBG,EAAEE,CAAC,EAAE,MAAMI,GAAEC,EAAAJ,EAAER,CAAC,IAAH,YAAAY,EAAM,MAAMC,EAAEF,GAAA,YAAAA,EAAG,IAAIJ,GAAG,GAAGI,GAAGE,EAAE,CAAC,GAAGA,EAAE,WAAeA,EAAE,WAAN,EAAe,CAACF,EAAE,OAAOJ,CAAC,EAAE,QAAQF,EAAE,EAAEA,EAAEG,EAAE,OAAOH,KAAIS,EAAAN,EAAEH,CAAC,IAAH,MAAAS,EAAM,MAAM,OAAOP,GAAGM,EAAE,YAAYA,EAAE,WAAW,MAAK,CAAE,CAAC,OAAOA,EAAE,QAAQ,CAAC,MAAO,EAAC,CAAC,SAASE,EAAEV,EAAEL,EAAEO,EAAE,WAAC,MAAMC,EAAEL,EAAE,IAAIE,CAAC,EAAE,GAAG,CAACG,EAAE,OAAaR,GAAN,KAAQE,EAAE,SAASG,EAAEE,CAAC,EAAE,KAAK,GAASP,GAAN,MAAeQ,EAAER,CAAC,GAAT,KAAW,CAAC,QAAQK,EAAE,EAAEA,EAAEG,EAAE,OAAOH,IAAI,CAAC,MAAML,GAAEY,EAAAJ,EAAEH,CAAC,IAAH,YAAAO,EAAM,MAAM,IAAIL,GAAG,GAAGP,EAAE,OAAOA,EAAE,WAAWA,EAAE,KAAK,CAAC,OAAOE,EAAE,SAASG,EAAEE,CAAC,CAAC,CAAC,MAAMI,GAAEG,EAAAN,EAAER,CAAC,IAAH,YAAAc,EAAM,MAAM,IAAIP,GAAG,GAAGI,EAAE,OAAOA,EAAE,WAAWA,EAAE,MAAM,QAAQE,EAAE,EAAEA,EAAEL,EAAE,OAAOK,IAAI,CAAC,GAAGA,IAAIb,GAAG,CAACQ,EAAEK,CAAC,EAAE,SAAS,MAAMR,GAAEW,EAAAR,EAAEK,CAAC,IAAH,YAAAG,EAAM,MAAML,EAAEN,GAAA,YAAAA,EAAG,IAAIE,GAAG,GAAGF,GAAGM,EAAE,OAAOA,EAAE,WAAWN,EAAE,IAAIE,EAAEI,CAAC,EAAEA,EAAE,KAAK,CAAC,OAAO,IAAI,CAAC,SAASM,EAAEZ,EAAEL,EAAEO,EAAEC,EAAEG,EAAE,KAAK,OAAC,MAAME,EAAEV,EAAE,IAAIE,CAAC,EAAE,GAAG,CAACQ,EAAE,OAAO,KAAWb,GAAN,MAASE,EAAE,SAASG,EAAEE,EAAEC,EAAEG,CAAC,GAAG,GAASX,GAAN,MAAea,EAAEb,CAAC,GAAT,KAAW,OAAO,KAAKE,EAAE,SAASG,EAAEE,EAAEC,EAAEG,CAAC,EAAE,MAAMP,EAAE,CAAC,SAAS,EAAE,MAAMI,EAAE,WAAW,GAAG,WAAW,GAAG,WAAWG,CAAC,EAAEH,EAAE,KAAM,IAAIJ,EAAE,WAAW,EAAI,EAAC,MAAO,IAAIA,EAAE,WAAW,EAAI,GAACQ,EAAAC,EAAEb,CAAC,IAAH,MAAAY,EAAM,MAAM,IAAIL,EAAEH,EAAE,CAAC,SAASc,EAAEb,EAAEL,EAAEO,EAAE,OAAC,MAAMC,EAAEL,EAAE,IAAIE,CAAC,EAAEG,EAAQR,GAAN,MAAeQ,EAAER,CAAC,GAAT,MAAWY,EAAAJ,EAAER,CAAC,IAAH,MAAAY,EAAM,MAAM,OAAOL,GAAGL,EAAE,YAAYG,EAAEE,CAAC,EAAQP,GAAN,MAASE,EAAE,YAAYG,EAAEE,CAAC,CAAC,CAAC,SAASY,EAAEd,EAAEL,EAAE,CAAC,MAAMO,EAAEJ,EAAE,IAAIE,CAAC,EAAE,OAAOE,EAAEA,EAAEP,CAAC,GAAG,KAAK,IAAI,CAAC,SAASoB,GAAEpB,EAAEG,EAAED,EAAEE,EAAEE,EAAEG,EAAE,EAAE,KAAK,CAAC,MAAMC,EAAES,EAAEnB,EAAEG,CAAC,EAAE,GAAG,CAACO,EAAE,OAAO,MAAMK,EAAEL,EAAE,OAAO,CAAC,MAAMO,EAAE,WAAWC,CAAC,EAAER,EAAE,GAAGK,GAAGA,EAAE,OAAOb,EAAE,MAAMa,EAAE,OAAOb,EAAE,MAAMa,EAAE,OAAOb,EAAE,MAAMa,EAAE,OAAOb,EAAE,KAAK,OAAOE,EAAEA,GAAG,EAAE,MAAMgB,EAAElB,EAAE,MAAO,EAAC,UAAS,EAAG,CAAC,iBAAiBmB,EAAE,UAAUC,CAAC,EAAEJ,EAAEK,EAAE,IAAI,IAAI,QAAQJ,EAAE,EAAEA,EAAEC,EAAE,OAAOD,IAAI,CAAC,MAAMnB,EAAEoB,EAAED,CAAC,EAAE,GAAGnB,EAAE,KAAKA,EAAE,MAAMI,GAAGJ,EAAE,KAAKA,EAAE,MAAMI,EAAE,SAAS,IAAID,EAAEI,EAAEP,EAAEqB,EAAE,CAAC,EAAEhB,EAAEiB,CAAC,IAAInB,EAAEmB,EAAE,iBAAiBnB,CAAC,GAAG,MAAMD,EAAE,IAAIW,EAAE,CAAC,EAAET,EAAE,EAAEA,EAAE,iBAAiBJ,EAAE,gBAAgB,CAAC,EAAE,GAASM,GAAN,MAAS,EAAEA,EAAEE,EAAEN,EAAEmB,EAAErB,EAAE,CAAC,GAAG,OAAO,KAAK,CAAC,aAAaU,EAAE,kBAAkBK,EAAE,iBAAiBE,CAAC,EAAEN,EAAEL,EAAEY,EAAET,GAAG,SAAS,EAAE,GAAGQ,EAAE,OAAO,KAAK,CAAC,YAAYO,CAAC,EAAEN,EAAE,CAAC,OAAOO,CAAC,EAAED,EAAEE,EAAE,CAAC,EAAE,KAAK,IAAI,EAAE,KAAK,OAAOvB,EAAE,KAAKsB,EAAE,GAAGV,EAAE,CAAC,CAAC,EAAE,EAAE,KAAK,IAAI,EAAE,KAAK,OAAOU,EAAE,EAAEtB,EAAE,MAAMY,EAAE,CAAC,CAAC,CAAC,EAAEY,EAAE,KAAK,MAAMxB,EAAE,KAAKA,EAAE,MAAMY,EAAE,EAAE,EAAE,EAAEa,EAAE,KAAK,MAAMzB,EAAE,KAAKA,EAAE,MAAMY,EAAE,EAAE,EAAE,EAAEc,EAAEnB,EAAE,EAAEc,EAAE,kBAAkBA,EAAE,WAAWM,EAAEpB,EAAE,EAAEc,EAAE,mBAAmBA,EAAE,YAAYO,EAAE,EAAEC,EAAE,KAAK,IAAI,EAAE,KAAK,MAAMN,EAAE,EAAEG,CAAC,EAAEE,CAAC,EAAE,EAAE,KAAK,IAAI,EAAE,KAAK,MAAML,EAAE,EAAEI,CAAC,EAAEC,CAAC,EAAEE,EAAE,KAAK,OAAOP,EAAE,EAAEC,EAAE,GAAGE,CAAC,EAAEE,EAAEG,EAAE,KAAK,OAAOR,EAAE,EAAEE,EAAE,GAAGE,CAAC,EAAEC,EAAE,QAAQ1B,EAAE,EAAEA,GAAG6B,EAAE7B,IAAI,QAAQL,EAAEgC,EAAEhC,GAAGiC,EAAEjC,IAAIuB,EAAE,IAAI,GAAGb,KAAKL,KAAKL,GAAG,CAAC,CAACiB,EAAE,QAAS,CAACZ,EAAEL,IAAI,CAAC,GAAG,CAACuB,EAAE,IAAIvB,CAAC,EAAE,CAAC,MAAMK,EAAEY,EAAE,IAAIjB,CAAC,GAASK,GAAN,MAASA,EAAE,YAAYA,EAAE,aAAaY,EAAE,OAAOjB,CAAC,CAAC,CAAC,CAAC,EAAGU,EAAE,OAAO,CAAC,KAAKR,EAAE,KAAK,KAAKA,EAAE,KAAK,KAAKA,EAAE,KAAK,KAAKA,EAAE,IAAI,CAAC"}