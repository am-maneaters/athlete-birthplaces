{"version":3,"file":"WFSSourceWorker-7331262a.js","sources":["../../node_modules/@arcgis/core/layers/graphics/sources/WFSSourceWorker.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.26/esri/copyright.txt for details.\n*/\nimport{createTask as e}from\"../../../core/asyncUtils.js\";import t from\"../../../core/Error.js\";import r from\"../../../core/Logger.js\";import{isSome as s,unwrap as a}from\"../../../core/maybe.js\";import{throwIfAborted as i,isAbortError as o}from\"../../../core/promiseUtils.js\";import{equals as n,WGS84 as u}from\"../../../geometry/support/spatialReferenceUtils.js\";import{convertFromGeometry as p,convertToGeometry as h}from\"../featureConversionUtils.js\";import y from\"../data/FeatureStore.js\";import{project as c,checkProjectionSupport as m}from\"../data/projectionSupport.js\";import{QueryEngine as l}from\"../data/QueryEngine.js\";import{validateGeoJSON as g,createOptimizedFeatures as f}from\"./geojson/geojson.js\";import{mixAttributes as _}from\"./support/sourceUtils.js\";import{getFeature as d}from\"../../ogc/wfsUtils.js\";import w from\"../../support/FieldsIndex.js\";class E{constructor(){this._queryEngine=null,this._customParameters=null,this._snapshotFeatures=async e=>{const{objectIdField:t}=this._queryEngine,r=await d(this._getFeatureUrl??\"\",this._featureType.typeName,this._getFeatureOutputFormat,{customParameters:this._customParameters,dateFields:this._queryEngine.fieldsIndex.dateFields.map((e=>e.name)),signal:e});await g(r),i(e);const a=f(r,{geometryType:this._queryEngine.geometryType,hasZ:!1,objectIdField:t});if(!n(this._queryEngine.spatialReference,u))for(const i of a)s(i.geometry)&&(i.geometry=p(c(h(i.geometry,this._queryEngine.geometryType,!1,!1),u,this._queryEngine.spatialReference)));let o=1;for(const s of a){const e={};_(this._fieldsIndex,e,s.attributes,!0),s.attributes=e,null==s.attributes[t]&&(s.objectId=s.attributes[t]=o++)}return a}}destroy(){this._queryEngine?.destroy(),this._queryEngine=null}async load(e,t){const{getFeatureUrl:r,getFeatureOutputFormat:s,spatialReference:o,fields:n,geometryType:u,featureType:p,objectIdField:h,customParameters:c}=e;this._featureType=p,this._customParameters=c,this._getFeatureUrl=r,this._getFeatureOutputFormat=s,this._fieldsIndex=new w(n),await this._checkProjection(o),i(t),this._queryEngine=new l({fields:n,geometryType:u,hasM:!1,hasZ:!1,objectIdField:h,spatialReference:o,timeInfo:null,featureStore:new y({geometryType:u,hasM:!1,hasZ:!1})});const m=await this._snapshotFeatures(a(t.signal));return this._queryEngine.featureStore.addMany(m),{extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async applyEdits(){throw new t(\"wfs-source:editing-not-supported\",\"applyEdits() is not supported on WFSLayer\")}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(e,t.signal)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForSnapping(e,t.signal)}async refresh(s){return this._customParameters=s,this._snapshotTask?.abort(),this._snapshotTask=e(this._snapshotFeatures),this._snapshotTask.promise.then((e=>{this._queryEngine.featureStore.clear(),e&&this._queryEngine.featureStore.addMany(e)}),(e=>{this._queryEngine.featureStore.clear(),o(e)||r.getLogger(\"esri.layers.WFSLayer\").error(new t(\"wfs-layer:getfeature-error\",\"An error occurred during the GetFeature request\",{error:e}))})),await this._waitSnapshotComplete(),{extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _checkProjection(e){try{await m(u,e)}catch{throw new t(\"unsupported-projection\",\"Projection not supported\",{spatialReference:e})}}}export{E as default};\n"],"names":["E","r","d","e","g","i","f","n","u","s","p","c","h","o","_","_a","w","l","y","m","a","t"],"mappings":"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"}