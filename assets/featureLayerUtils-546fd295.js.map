{"version":3,"file":"featureLayerUtils-546fd295.js","sources":["../../node_modules/@arcgis/core/layers/save/featureLayerUtils.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.26/esri/copyright.txt for details.\n*/\nimport{difference as e}from\"../../core/arrayUtils.js\";import t from\"../../core/Error.js\";import r from\"../../core/Logger.js\";import{isNone as a,isSome as o}from\"../../core/maybe.js\";import{debounce as s,eachAlways as l}from\"../../core/promiseUtils.js\";import{updateOrigins as i}from\"../../core/accessorSupport/originUtils.js\";import n from\"../FeatureLayer.js\";import{parse as u}from\"../support/arcgisLayerUrl.js\";import{fetchFeatureService as p}from\"../support/fetchService.js\";import{isFeatureCollectionLayer as c,isFeatureServiceLayer as y}from\"../support/layerUtils.js\";import d from\"../../portal/Portal.js\";import m from\"../../portal/PortalItem.js\";import{createForItemWrite as f}from\"../../portal/support/jsonContext.js\";import{addTypeKeyword as w,TypeKeyword as h,getWGS84ExtentForItem as v,removeTypeKeyword as b}from\"../../portal/support/portalItemUtils.js\";const I=r.getLogger(\"esri.layers.FeatureLayer\"),S=\"Feature Service\";function g(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function j(e,r){if(r.type!==S)throw new t(\"feature-layer:portal-item-wrong-type\",g(e,`should have portal item of type \"${S}\"`))}async function L(e){if(await e.load(),c(e))throw new t(\"feature-layer:save\",g(e,\"using an in-memory source cannot be saved to a portal item\"))}function P(e,r){let a=(e.messages??[]).filter((({type:e})=>\"error\"===e)).map((({name:e,message:r,details:a})=>new t(e,r,a)));if(r?.ignoreUnsupported&&(a=a.filter((({name:e})=>\"layer:unsupported\"!==e&&\"symbol:unsupported\"!==e&&\"symbol-layer:unsupported\"!==e&&\"property:unsupported\"!==e&&\"url:unsupported\"!==e))),a.length>0)throw new t(\"feature-layer:save\",\"Failed to save feature layer due to unsupported or invalid content. See 'details.errors' for more detailed information\",{errors:a})}async function J(e,t,r){\"beforeSave\"in e&&\"function\"==typeof e.beforeSave&&await e.beforeSave();const a=e.write({},t);return P(t,r),a}function N(e){const{layer:t,layerJSON:r}=e;return t.isTable?{layers:[],tables:[r]}:{layers:[r],tables:[]}}function O(e){w(e,h.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}function E(e){const r=e.portalItem;if(!r)throw I.error(\"save: requires the portalItem property to be set\"),new t(\"feature-layer:portal-item-not-set\",g(e,\"requires the portalItem property to be set\"));if(!r.loaded)throw new t(\"feature-layer:portal-item-not-loaded\",g(e,\"cannot be saved to a portal item that does not exist or is inaccessible\"));j(e,r)}async function T(e,t){return/\\/\\d+\\/?$/.test(e.url??\"\")?N(t[0]):$(e,t)}async function $(e,t){const{layer:{url:r,customParameters:a,apiKey:o}}=t[0];let s=await e.fetchData(\"json\");s&&null!=s.layers&&null!=s.tables||(s=await x(s,{url:r??\"\",customParameters:a,apiKey:o},t.map((e=>e.layer.layerId))));for(const l of t)K(l.layer,l.layerJSON,s);return s}async function x(e,t,r){var a,o;e||(e={}),(a=e).layers||(a.layers=[]),(o=e).tables||(o.tables=[]);const{url:s,customParameters:l,apiKey:i}=t,{serviceJSON:n,layersJSON:u}=await p(s,{customParameters:l,apiKey:i}),c=A(e.layers,n.layers,r),y=A(e.tables,n.tables,r);e.layers=c.itemResources,e.tables=y.itemResources;const d=[...c.added,...y.added],m=u?[...u.layers,...u.tables]:[];return await U(e,d,s,m),e}function A(t,r,a){const o=e(t,r,((e,t)=>e.id===t.id));t=t.filter((e=>!o.removed.some((t=>t.id===e.id))));const s=o.added.map((({id:e})=>({id:e})));return s.forEach((({id:e})=>{t.push({id:e})})),{itemResources:t,added:s.filter((({id:e})=>!a.includes(e)))}}async function U(e,t,r,o){const s=t.map((({id:e})=>new n({url:r,layerId:e,sourceJSON:o.find((({id:t})=>t===e))})));await l(s.map((e=>e.load()))),s.forEach((t=>{const{layerId:r,loaded:o,defaultPopupTemplate:s}=t;if(!o||a(s))return;K(t,{id:r,popupInfo:s.toJSON()},e)}))}function K(e,t,r){e.isTable?F(r.tables,t):F(r.layers,t)}function F(e,t){if(!e)return;const r=e.findIndex((({id:e})=>e===t.id));-1===r?e.push(t):e[r]=t}function R(e){const{portalItem:t}=e;return y(e)&&!e.dynamicDataSource&&!!t?.loaded&&t.type===S}async function D(e){if(!e?.length)throw new t(\"feature-layer-utils-saveall:missing-parameters\",\"'layers' array should contain at least one feature layer\");await Promise.all(e.map((e=>e.load())));for(const o of e)if(!R(o))throw new t(\"feature-layer-utils-saveall:invalid-parameters\",`'layers' array should only contain layers or tables in a feature service loaded from 'Feature Service' item. ${g(o,\"does not conform\")}`,{layer:o});const r=e.map((e=>e.portalItem.id));if(new Set(r).size>1)throw new t(\"feature-layer-utils-saveall:invalid-parameters\",\"All layers in the 'layers' array should be loaded from the same portal item\");const a=e.map((e=>e.layerId));if(new Set(a).size!==a.length)throw new t(\"feature-layer-utils-saveall:invalid-parameters\",\"'layers' array should contain only one instance each of layer or table in a feature service\")}function q(e,t){var r,a;let o=m.from(t);return o.id&&(o=o.clone(),o.id=null),(r=o).type??(r.type=S),(a=o).portal??(a.portal=d.getDefault()),j(e,o),o}async function z(e,t){const{url:r,layerId:a,title:s,fullExtent:l,isTable:i}=e,n=u(r),p=o(n)&&\"FeatureServer\"===n.serverType;t.url=p?r:`${r}/${a}`,t.title||(t.title=s),t.extent=null,!i&&o(l)&&(t.extent=await v(l)),b(t,h.METADATA),b(t,h.MULTI_LAYER),w(t,h.SINGLE_LAYER),i&&w(t,h.TABLE),O(t)}async function C(e,t,r){const a=e.portal;await(a?.signIn()),await(a?.user?.addItem({item:e,data:t,folder:r?.folder}))}const M=s(Y);async function Y(e,t){await L(e),E(e);const r=e.portalItem,a=f(r),o=await J(e,a,t),s=await T(r,[{layer:e,layerJSON:o}]);return O(r),await r.update({data:s}),i(a),r}const _=s((async(e,t)=>{await D(e);const r=e[0].portalItem,a=f(r),o=await Promise.all(e.map((e=>J(e,a,t)))),s=await T(r,e.map(((e,t)=>({layer:e,layerJSON:o[t]}))));return O(r),await r.update({data:s}),await Promise.all(e.slice(1).map((e=>e.portalItem.reload()))),i(a),r.clone()})),B=s(G);async function G(e,t,r){await L(e);const a=q(e,t),o=f(a),s=N({layer:e,layerJSON:await J(e,o,r)});return await z(e,a),await C(a,s,r),e.portalItem=a,i(o),a}export{M as save,_ as saveAll,B as saveAs};\n"],"names":["I","r","S","g","e","t","j","L","c","P","a","J","N","O","w","h","E","T","$","o","s","x","K","n","u","p","y","d","m","U","l","F","R","D","q","z","i","v","b","C","_a","M","Y","f","_","B","G"],"mappings":"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"}